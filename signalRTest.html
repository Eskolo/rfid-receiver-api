<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RFID Status Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.7/signalr.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #f9f9f9; margin: 0; padding: 1rem; }
    h2 { margin-top: 0 }

    table {
      width: 100%; border-collapse: collapse; margin-bottom: 1rem;
    }
    th, td {
      border: 1px solid #ccc; padding: 0.5rem; text-align: left;
    }
    th { background: #eee; }

    .present { color: green; font-weight: bold; }
    .absent { color: red; font-weight: bold; }

    #console {
      height: 200px;
      overflow-y: auto;
      background: #000;
      color: #0f0;
      font-family: monospace;
      font-size: 0.85rem;
      padding: 0.5rem;
      border: 1px solid #333;
    }
    pre { margin: 0 }
  </style>
</head>
<body>
  <h2>RFID Status Dashboard</h2>

  <table id="itemsTable">
    <thead>
      <tr>
        <th>Tag ID</th>
        <th>Name</th>
        <th>Location ID</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="itemsBody"></tbody>
  </table>

  <div id="console"></div>

  <script>
    const consoleDiv = document.getElementById("console");
    const itemsBody = document.getElementById("itemsBody");
    const itemMap = {}; // tagId → <tr> row
    const baseUrl = "http://localhost:5202";

    function log(msg) {
      const line = document.createElement("pre");
      line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      consoleDiv.appendChild(line);
      consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }

    function createRow(item) {
        const tr = document.createElement("tr");
        tr.dataset.tagId = item.id;

        const tdId = document.createElement("td");
        tdId.textContent = item.id;

        const tdName = document.createElement("td");
        tdName.textContent = item.name;

        const tdLoc = document.createElement("td");
        tdLoc.textContent = item.location;

        const tdStatus = document.createElement("td");
        tdStatus.textContent = item.isPresent ? "Present" : "Absent";
        tdStatus.className = item.isPresent ? "present" : "absent";
        tdStatus.classList.add("statusCell");

        tr.appendChild(tdId);
        tr.appendChild(tdName);
        tr.appendChild(tdLoc);
        tr.appendChild(tdStatus);

        itemsBody.appendChild(tr);
        itemMap[item.id] = tr;
    }


    async function loadItems() {
      try {
        const res = await fetch(baseUrl + "/api/item/GetAllItems");
        const json = await res.json();
        const items = json["$values"];
        itemsBody.innerHTML = "";
        items.forEach(item => createRow(item));
        log(`Loaded ${items.length} items`);
      } catch (err) {
        log(`Failed to fetch items: ${err.message}`);
      }
    }

    const connection = new signalR.HubConnectionBuilder()
      .withUrl(baseUrl + "/rfidHub")
      .withAutomaticReconnect()
      .configureLogging(signalR.LogLevel.Information)
      .build();

    // updateStatus(tagId, isPresent)
    connection.on("updateStatus", (tagId, isPresent) => {
      const row = itemMap[tagId];
      if (row) {
        const statusCell = row.querySelector(".statusCell");
        statusCell.textContent = isPresent ? "Present" : "Absent";
        statusCell.className = "statusCell " + (isPresent ? "present" : "absent");
        log(`Status updated: ${tagId} → ${isPresent ? "Present" : "Absent"}`);
      } else {
        log(`Tag not found in list: ${tagId}`);
      }
    });

    // ReceiveMessage(tagId, locationId, signalStrength)
    connection.on("receiveMessage", (tagId, name, locationId, signalStrength) => {
      log(`ReceiveMessage → Tag: ${tagId}, Name: ${name}, Location: ${locationId}, Signal: ${signalStrength}`);
    });

    connection.onclose(err => log(`Connection closed: ${err?.message || "unknown"}`));

    async function startSignalR() {
      try {
        await connection.start();
        log("Connected to SignalR hub");
      } catch (err) {
        log(`SignalR connection failed: ${err.message}`);
        setTimeout(startSignalR, 5000);
      }
    }

    loadItems();
    startSignalR();
  </script>
</body>
</html>
